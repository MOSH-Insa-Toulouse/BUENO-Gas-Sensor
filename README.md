# Connected gas sensor

## Author
Th√©o BUENO, 2018

Part of the gas sensor circuit was designed by Jean-Louis NOULLET.

## About this project
This project is part of the Microcontrollers and Open-Source Hardware (Smart Devices) lecture of the Innovative Smart Systems program at INSA Toulouse.

During this lecture we learned specifics of microcontrollers through Arduino and Open-Source Hardware. We learned how to leverage the Arduino platform to prototype and quickly iterate projects.

We also learned to use the KiCad EDA free software to design our own PCBs.

The evaluation of this class is a (this) project that gave us the opportunity to make use of everything we learned on a practical project: a LoRa-connected gas sensor.

## Presentation
This gas sensor is a standalone Arduino board embedded a RN2483 LoRa modem, a nanoparticle gas sensor with its amplification circuit and a connector for a Grove MQ-x gas sensor (for calibration purposes).

It can be reprogrammed through external headers, and was designed for the lowest power consumption possible.

![alt text][side]

The Atmega328P handles communication over UART with the LoRa modem and connects to the LoRaWAN network "The Things Network".

Data acquisition from the gas sensor can be made with the integrated grove sensor, or with the embedded nanoparticles gas sensor through Atmega328p's DAC.

There are two LEDs: one indicates power supply and the other data transmission over the Atmega328P's hardware serial (for programming). Both are optional. The RN2483 is controlled over software UART. The microcontroller can reset the RN2483 when needed.

## Software
### Atmega328P
#### Bootloader
Brand new Atmega328Ps are not burned with a bootloader that allow for the Arduino IDE to reflash them through serial.

In order to flash them, you need to burn the bootloader included with the Arduino distribution. This process needs any working Arduino board and a virgin Atmega chip. Process can be found on the official Arduino documentation: [Burning the Bootloader](https://www.arduino.cc/en/Tutorial/ArduinoToBreadboard).

#### Firmware
Firmware can be compiled and flashed with the Arduino IDE. You need a USB/Serial adapter like [Sparkfun's FTDI Basic Breakout](https://www.sparkfun.com/products/9716) which has a compatible header pinout with this project.

#### Arduino
Software is a single file Arduino program. Communication and interfacing with the RN2483 modem is done with the [The Things Network Arduino library](https://www.thethingsnetwork.org/docs/devices/arduino/).

We simply poll the ADC to get the value from the gas sensor. If values reaches a threshold data is sent over the LoRaWAN network to the NodeRed dashboard.

We support LoRa downlinks.

LoRa trame counter could use Atmega328P's internal EEPROM. If not, trame count check should be disabled on the LoRa network used (The Things Network dashboard for instance). I chose not to because EEPROMs have a limited write cycle count.

### Dashboard
NodeRed dashboard: to be completed

## Hardware
All hardware components were designed using the KiCad EDA. KiCad is free software and developed by volunteers all around the world. You can support its continued development by [donating to the CERN Foundation](https://giving.web.cern.ch/civicrm/contribute/transact?reset=1&id=6), which is investing a lot of ressources and efforts to make KiCad a competitive software.

### Schematic
The schematic was designed using hierarchical sheets.
![alt text][schematic]

You can navigate to and from any submodules by using the hierarchy view tool on KiCad. This way you can also see the connections between submodules of the design in a clear way. The drawback of this method is that it generates prints with lots of pages even for small circuits.

### Circuit design
![alt text][PCB]
The circuit is 1-layer only (top), with the 2nd layer (bottom) being the ground plane. Only one connection could not be routed on the top side and required two vias to put a strap on the top (the 3.3V line between regulator and RN2483 modem).

![alt text][bottom]

I tried to minimize as much as possible the PCB footprint, and I do not think it could get much smaller with the amount of THT components and the RN2483 breakout we use.

Track size is 20 mil, with 24 mil isolation.

### Power
The embedded gas sensor needs to be regenerated by heating up its internal resistor. This process is very power hungry and can be triggered only when needed by the microcontroller by piloting a MOSFET. This prevents sensor heating from uselessly draining power from supply.

Power supply can be provided by a male jack connector, or with the male headers on the board. Power source is selected with the switch located just behind the jack connector. If one of the power source is not connected, switch acts as a power on/off control.

On the Grove gas sensor that can be used for calibration, there is no control over heating, hence if it is connected it will drain power for as long as it is connected (about 400 mAH in experiments).

LoRa modem RN2483 uses about 20 to 30 mAH when transmitting, and 3.3V power supply is provided by a dedicated regulator. A voltage divider with resistors was also tested and proved to work but drained battery even when the modem was idle.

The Atmega328P should not take more than 20 mAH, which make this circuit quite power efficient when not transmitting or recycling sensor.

You have the option to "hack" the board to use a voltage divider with two resistors in lieu of the 3.3V regulator thanks to its compatible pin layout.

### Improvements
Big TO-220 packages are a waste of space. Design would benefit from smaller packages for 3.3V/5V regulators and MOSFET.

There is no logic level shifter between the RN2483 (3.3V logic) and the Atmega328P (5V logic). Pray that your RN2483 is 5V tolerant .

Some tracks are really close to the mounting holes of the RN2483 breakout or to pads. It would be better to optimize routing and components placement to isolate them better.

We could imagine a design with an onboard battery charger coupled with photovoltaic cells and a battery, that could allow for sensor recycling when a lot of power is available. That would make this sensor completely power self-dependant. Presently extended use is not possible on batteries, although its power management makes it quite power efficient (40 mAH at 5V is 0.2W).

[top]: Images/top.png "Board preview from the top"
[side]: Images/top_side.png "Board preview from the side"
[bottom]: Images/bottom.png "Board preview from the bottom"
[PCB]: Images/PCB.png "PCB preview"
[schematic]: Images/schematic_main.png "Main sheet schematic view"